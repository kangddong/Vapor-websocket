//
//  WebSocketClient.swift
//  Vapor-websocket-iOS
//
//  Created by ê°•ë™ì˜ on 4/6/25.
//


import Foundation

class WebSocketClient {
    private var webSocket: URLSessionWebSocketTask?
    private let url = URL(string: "ws://localhost:8080/echo")! // Vapor ì„œë²„ ì£¼ì†Œ
    
    var onReceive: ((String) -> Void)?
    
    func connect() {
        let session = URLSession(configuration: .default)
        webSocket = session.webSocketTask(with: url)
        webSocket?.resume()
        
        print("ğŸ› ï¸ WebSocket ì—°ê²° ì‹œë„ ì¤‘...")
        listen()
    }
    
    func send(message: String) {
        let wsMessage = URLSessionWebSocketTask.Message.string(message)
        webSocket?.send(wsMessage) { error in
            if let error = error {
                print("âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:", error)
            } else {
                print("ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡ë¨: \(message)")
            }
        }
    }
    
    private func listen() {
        webSocket?.receive { [weak self] result in
            switch result {
            case .success(let message):
                switch message {
                case .string(let text):
                    print("ğŸ“¨ ë°›ì€ ë©”ì‹œì§€: \(text)")
                    self?.onReceive?(text)
                case .data(let data):
                    print("ğŸ“¦ ë°”ì´ë„ˆë¦¬ ë°ì´í„° ìˆ˜ì‹ ë¨: \(data)")
                @unknown default:
                    break
                }
                // ê³„ì†í•´ì„œ ë‹¤ìŒ ë©”ì‹œì§€ ìˆ˜ì‹  ëŒ€ê¸°
                self?.listen()
            case .failure(let error):
                print("âŒ ìˆ˜ì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error)
            }
        }
    }
    
    func disconnect() {
        webSocket?.cancel(with: .goingAway, reason: nil)
        print("ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œë¨")
    }
}
